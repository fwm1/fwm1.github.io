---
title: Redis核心机制
date: 2022-03-24 22:24:28
tags: [redis]
categories: 中间件
---



### Redis主从复制

作用：数据冗余、故障恢复、负载均衡、高可用

复制方式：全量复制和增量复制

##### 全量复制

1. 主从库间建立连接、协商同步

   具体来说，从库给主库发送 psync 命令，表示要进行数据同步，主库根据这个命令的参数来启动复制。psync 命令包含了**主库的 runID** 和复**制进度 offset** 两个参数。runID，是每个 Redis 实例启动时都会自动生成的一个随机 ID，用来唯一标记这个实例。当从库和主库第一次复制时，因为不知道主库的 runID，所以将 runID 设为“？”。offset，此时设为 -1，表示第一次复制。主库收到 psync 命令后，会用 FULLRESYNC 响应命令带上两个参数：主库 runID 和主库目前的复制进度 offset，返回给从库。从库收到响应后，会记录下这两个参数。这里有个地方需要注意，FULLRESYNC 响应表示第一次复制采用的全量复制，也就是说，主库会把当前所有的数据都复制给从库。

2. 主库将所有数据同步给从库

   具体来说，主库执行 bgsave 命令，生成 RDB 文件，接着将文件发给从库。从库接收到 RDB 文件后，会先清空当前数据库，然后加载 RDB 文件。在主库将数据同步给从库的过程中，主库不会被阻塞，仍然可以正常接收请求但是，这些请求中的写操作并没有记录到刚刚生成的 RDB 文件中。为了保证主从库的数据一致性，主库会在内存中用专门的 **replication buffer**，记录 RDB 文件生成后收到的所有写操作。

3. 主库会把第二阶段执行过程中新收到的写命令，再发送给从库

   从库接受到新的写命令后，再重新执行这些操作。



### 哨兵机制

作用：主节点的自动故障转移

Redis Sentinel本身也是一个集群，可以：

1. 对于redis数据节点的连通信由多个sentinel节点共同决定（主观、客观下线），避免误判；
2. sentinel本身的高可用

哨兵实现的功能：

1. 监控：其他sentinel节点  以及  redis主从节点
2. 通知：通知上层应用
3. **自动故障转移**
4. 客户端的配置中心，客户端在初始化的时候连接的是Sentinel节点集合，从中获取主节点信息

#### 原理

##### 监控

sentinel节点监控其他sentinel节点  以及  redis主从节点，是通过pub/sub功能实现的。

sentinel节点有3个定时任务：

1. 节点状态监控。每1秒向其他sentinel节点和redis主从节点发送**PING**命令，检测连通信
2. sentinel节点信息交换。每2秒向redis主节点的"____sentinel____hello"的channel发送自身信息以及对自己认为的主节点信息。
3. 监控主从拓扑结构信息。每10s，每个sentinel节点会向主从节点发送**INFO**命令，获取主从信息。

##### Sentinel Leader选举（Raft）



##### 故障转移

选举出的Leader Sentinel节点将负责故障转移。

1. 从slave节点中筛选出一个作为新的master，判断条件有以下几点：
   1. 跟主节点断开时时长。如果一个slave跟master的断开连接时长已经超过了down-after-milliseconds的10倍，外加master宕机的时长，那么该slave就被认为不适合选举为master。
   2. slave的优先级配置：slave priority参数值越小，优先级就越高。
   3. 复制offset：当优先级相同时，哪个slave复制了越多的数据（offset越靠后），优先级越高。
   4. run id：如果offset和优先级都相同，则哪个slave的run id越小，优先级越高。
2. 对最终筛选出来的slave节点执行**slaveof no one**命令，使其成为主节点。
3. Leader Sentinel向剩余的slave节点发送命令，让它们成为新的master节点的从节点。
4. Leader Sentinel会将原来的主节点更新为从节点，并当其恢复后命令它去复制新的主节点。



